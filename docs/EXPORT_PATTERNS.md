# Export Patterns and Default Implementations

This document defines the default export patterns for each library type in the monorepo generator.
Following TypeScript monorepo best practices (2025), barrel files are used **only** at library boundaries.

## References

- [TypeScript Monorepo Best Practices](https://tkdodo.eu/blog/please-stop-using-barrel-files)
- [Nx Workspace Organization](https://nx.dev/blog/virtuous-cycle-of-workspace-structure)
- [Effect-TS Service Patterns](https://deepwiki.com/Effect-TS/effect)

## Package.json Exports Configuration

All libraries follow the same package.json export structure (generated by `library-generator-utils.ts`):

```json
{
  "name": "@workspace-scope/{type}-{name}",
  "type": "module",
  "exports": {
    ".": {
      "import": "./src/index.ts",
      "types": "./src/index.ts"
    },
    "./server": {
      "import": "./src/server.ts",
      "types": "./src/server.ts"
    },
    "./client": {
      "import": "./src/client.ts",
      "types": "./src/client.ts"
    },
    "./edge": {
      "import": "./src/edge.ts",
      "types": "./src/edge.ts"
    }
  }
}
```

**Note:** `@workspace-scope` is automatically detected from your workspace's root `package.json`. The generator dynamically extracts your package scope instead of using hardcoded values.

**Platform-specific exports are conditional:**
- `./server` - Generated based on `shouldGenerateServer` flag
- `./client` - Generated based on `shouldGenerateClient` flag
- `./edge` - Generated based on `includeEdgeExports` flag

## Library Type: Contract

**Purpose:** Domain boundaries via interfaces, entities, errors, and events

**Platform:** Universal (no platform-specific exports)

### Default Exports (src/index.ts)

```typescript
// Core Exports
export * from "./lib/errors";      // Domain errors (Data.TaggedError)
export * from "./lib/entities";    // Domain entities with Schema validation
export * from "./lib/ports";       // Repository and service interfaces
export * from "./lib/events";      // Domain events

// Conditional: CQRS Exports (if includeCQRS)
export * from "./lib/commands";    // Command definitions
export * from "./lib/queries";     // Query definitions
export * from "./lib/projections"; // Projection definitions

// Conditional: RPC Exports (if includeRPC)
export * from "./lib/rpc";         // RPC schemas (Schema.TaggedError for serialization)
```

### Package.json

```json
{
  "exports": {
    ".": "./src/index.ts"
  }
}
```

**No platform-specific exports** - Contract libraries are pure definitions.

---

## Library Type: Data-Access

**Purpose:** Repository implementations and database queries

**Platform:** Server-only

### Default Exports (src/index.ts)

```typescript
// Error Types
export {
  ProductRepositoryError,      // Base error
  ProductNotFoundError,
  ProductValidationError,
  ProductConflictError,
  ProductConfigError,
  ProductConnectionError,
  ProductTimeoutError,
  ProductInternalError
} from "./lib/shared/errors";
export type { ProductRepositoryErrors } from "./lib/shared/errors"// Domain Types
export type {
  Product,              // Entity type
  ProductInsert,        // Create input
  ProductUpdate,        // Update input
  ProductFilter,        // Query filter
  ProductSort,          // Sort options
  PaginationOptions     // Pagination
} from "./lib/domain"// Validation Functions
export * from "./lib/validation"// Query Builders
export {
  buildFindAllQuery,
  buildFindByIdQuery,
  buildCountQuery
} from "./lib/queries"// Repository (Effect 3.0+ Pattern)
export { ProductRepository } from "./lib/repository"// Usage: ProductRepository.Live, ProductRepository.Test, ProductRepository.Auto
```

### Package.json

```json
{
  "exports": {
    ".": "./src/index.ts"
  }
}
```

**No client exports** - Data-access is server-only.

---

## Library Type: Feature

**Purpose:** Business logic, services, RPC endpoints, client hooks/atoms

**Platform:** Universal with platform-specific exports

### Default Exports (src/index.ts) - Universal

```typescript
// Shared Types (type-only exports)
export type * from "./lib/shared/types";
export type * from "./lib/shared/errors"// Conditional: RPC Definitions (if includeRPC)
export type * from "./lib/rpc/rpc";
```

**Platform-specific exports guidance included in comments:**
```typescript
// SERVER (Node.js):
//   import { ProductService } from '@workspace-scope/feature-product/server';
//
// CLIENT (Browser):
//   import { useProduct } from '@workspace-scope/feature-product/client';
//
// EDGE (Cloudflare Workers, Vercel Edge):
//   import { productMiddleware } from '@workspace-scope/feature-product/edge';
```

### Server Exports (src/server.ts) - Always Generated

```typescript
// Server-side exports
export * from './lib/server/service';  // ProductService (Context.Tag)
export * from './lib/server/layers';   // ProductServiceLive, ProductServiceTest, ProductServiceAuto

// Conditional: RPC Handlers (if includeRPC)
export * from './lib/rpc/handlers';
```

### Client Exports (src/client.ts) - Conditional

**Generated when:** `includeClientServer === true` OR `platform === "browser"` OR `platform === "universal"`

```typescript
// Client-side exports
export type * from './lib/shared/types';   // Type-only (browser-safe)
export type * from './lib/shared/errors';  // Type-only (browser-safe)

// Conditional: React Hooks and Atoms (if includeClientServer)
export * from './lib/client/hooks';        // useProduct, etc.
export * from './lib/client/atoms';        // productAtoms, etc.
```

### Edge Exports (src/edge.ts) - Conditional

**Generated when:** `includeEdge === true`

```typescript
// Edge runtime exports
export * from './lib/edge/middleware';
export * from './lib/shared/types';
export * from './lib/shared/errors';
```

### Package.json

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./server": "./src/server.ts",
    "./client": "./src/client.ts",   // If includeClientServer
    "./edge": "./src/edge.ts"          // If includeEdge
  }
}
```

---

## Library Type: Infrastructure

**Purpose:** Cross-cutting concerns (logging, caching, database connections)

**Platform:** Server-only (typically), with optional client variants

### Default Exports (src/index.ts) - Universal Types

```typescript
// Type-only exports (universal)
export type * from "./lib/service/interface";  // Service interface
export type * from "./lib/service/errors";     // Error types
```

### Server Exports (src/server.ts) - Always Generated

```typescript
// Server-side exports
export { CacheService } from "./lib/service/service";
export { CacheServiceLive, CacheServiceTest } from "./lib/layers/server-layers";
export { MemoryCacheProvider } from "./lib/providers/memory"// Error Types
export {
  CacheServiceError,
  CacheNotFoundError,
  CacheValidationError,
  CacheInternalError
} from "./lib/service/errors";
export type { CacheServiceErrors } from "./lib/service/errors";
```

### Client Exports (src/client.ts) - Conditional

**Generated when:** `includeClientServer === true`

```typescript
// Client-side exports
export { CacheServiceClient } from "./lib/layers/client-layers";
export { useCache } from "./lib/client/hooks/use-cache";
```

### Edge Exports (src/edge.ts) - Conditional

**Generated when:** `includeEdge === true`

```typescript
// Edge runtime exports
export * from "./lib/layers/edge-layers";
```

### Package.json

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./server": "./src/server.ts",
    "./client": "./src/client.ts",   // Rare - only if browser-safe variant exists
    "./edge": "./src/edge.ts"          // If includeEdge
  }
}
```

---

## Library Type: Provider

**Purpose:** External SDK adapters (Stripe, Redis, S3, etc.)

**Platform:** Universal with platform-specific exports

### Default Exports (src/index.ts)

```typescript
// Error Types
export {
  StripeServiceError,
  StripeNotFoundError,
  StripeValidationError,
  StripeInternalError
} from "./lib/errors";
export type { StripeServiceErrors } from "./lib/errors"// Type Definitions
export type * from "./lib/types"// Service Implementation (Effect 3.0+ Pattern)
export { StripeService } from "./lib/service"// Validation Utilities
export * from "./lib/validation"// Layer Compositions
export * from "./lib/layers";  // StripeServiceLive, StripeServiceTest, StripeServiceDev, StripeServiceAuto
```

**Usage Pattern:**
```typescript
import { StripeService } from '@workspace-scope/provider-stripe';
const layer = StripeService.Live;
```

### Server Exports (src/server.ts) - Conditional

**Generated when:** `platform === "node"` OR `platform === "universal"`

```typescript
// Server-side exports
export * from "./index";
export * from "./lib/layers";  // All layers (Live, Dev, Test, Auto)
```

### Client Exports (src/client.ts) - Conditional

**Generated when:** `platform === "browser"` OR `platform === "universal"`

```typescript
// Client-side exports (for browser-compatible SDKs)
export type * from "./lib/types";
export * from "./lib/errors";
export { StripeService } from "./lib/service";
export * from "./lib/layers";
```

### Edge Exports (src/edge.ts) - Conditional

**Generated when:** `platform === "edge"`

```typescript
// Edge runtime exports (for edge-compatible SDKs)
export type * from "./lib/types";
export * from "./lib/errors";
export { StripeService } from "./lib/service";
export * from "./lib/layers";
```

### Package.json

```json
{
  "exports": {
    ".": "./src/index.ts",
    "./server": "./src/server.ts",     // If platform=node or universal
    "./client": "./src/client.ts",     // If platform=browser or universal
    "./edge": "./src/edge.ts"          // If platform=edge
  }
}
```

**Platform-specific exports** are now supported for providers to enable better tree-shaking and runtime compatibility.

---

## Effect 3.0+ Pattern: Static Layer Members

All services follow the **Context.Tag with static layer members** pattern:

```typescript
// Service Definition
export class ProductService extends Context.Tag("ProductService")<
  ProductService,
  {
    readonly getById: (id: string) => Effect.Effect<Product, ProductServiceError>
    // ... more methods
  }
>() {
  static readonly Live = Layer.effect(
    this,
    Effect.gen(function*() {
      // Implementation
    })
  )

  static readonly Test = Layer.succeed(this, {
    // Mock implementation
  })

  static readonly Auto =
    process.env.NODE_ENV === "production"
      ? this.Live
      : process.env.NODE_ENV === "test"
        ? this.Test
        : this.Live;
}
```

**Migration from pre-3.0:**
```typescript
// OLD (pre-3.0)
import { ProductServiceLive } from '@workspace-scope/feature-product';
const layer = ProductServiceLive// NEW (3.0+)
import { ProductService } from '@workspace-scope/feature-product/server';
const layer = ProductService.Live;
```

---

## Import Examples

### Contract Library
```typescript
// Domain entities and interfaces
import type { Product, ProductRepository } from '@workspace-scope/contract-product';
import { ProductNotFoundError } from '@workspace-scope/contract-product';
```

### Data-Access Library
```typescript
// Repository implementation (server-only)
import { ProductRepository } from '@workspace-scope/data-access-product';
const layer = ProductRepository.Live;
```

### Feature Library
```typescript
// Server-side service
import { ProductService } from '@workspace-scope/feature-product/server'// Client-side hooks
import { useProduct } from '@workspace-scope/feature-product/client'// Edge middleware
import { productMiddleware } from '@workspace-scope/feature-product/edge'// Universal types
import type { ProductInput } from '@workspace-scope/feature-product';
```

### Infrastructure Library
```typescript
// Server-side service
import { CacheService } from '@workspace-scope/infra-cache/server'// Client-side (if browser-safe variant exists)
import { useCache } from '@workspace-scope/infra-cache/client';
```

### Provider Library
```typescript
// External service adapter (server-only)
import { StripeService } from '@workspace-scope/provider-stripe/server';
const layer = StripeService.Live// Browser-compatible SDK (if applicable)
import { StripeService } from '@workspace-scope/provider-stripe/client'// Edge runtime (if applicable)
import { StripeService } from '@workspace-scope/provider-stripe/edge';
```

---

## Best Practices

### ✅ DO

1. **Use explicit platform imports** for clear boundaries:
   ```typescript
   import { ProductService } from '@workspace-scope/feature-product/server';
   ```

2. **Use type-only imports** when possible for better tree-shaking:
   ```typescript
   import type { Product } from '@workspace-scope/contract-product';
   ```

3. **Access layers via static members** (Effect 3.0+):
   ```typescript
   const layer = ProductService.Live;
   ```

4. **Follow the dependency rules**:
   - Features depend on data-access and contract
   - Data-access depends on contract
   - Contract depends on nothing (leaf nodes)

### ❌ DON'T

1. **Don't mix client and server imports:**
   ```typescript
   // Bad - imports server code in client bundle
   import { ProductService } from '@workspace-scope/feature-product';
   ```

2. **Don't use relative imports** between libraries:
   ```typescript
   // Bad
   import { ProductRepository } from '../../../data-access/product'   // Good
   import { ProductRepository } from '@workspace-scope/data-access-product';
   ```

3. **Don't create circular dependencies:**
   ```typescript
   // Bad - contract importing from feature
   import { ProductService } from '@workspace-scope/feature-product';
   ```

4. **Don't use barrel files inside libraries** (only at boundaries):
   ```typescript
   // Bad - internal barrel file
   libs/feature/product/src/lib/utils/index.ts

   // Good - direct imports
   libs/feature/product/src/lib/utils/formatting.ts
   ```

---

## Automated Generation

The export patterns are automatically generated by:

1. **`library-generator-utils.ts`** - Generates package.json with exports field
2. **`{type}/templates/index.template.ts`** - Generates src/index.ts barrel exports
3. **`{type}/templates/server.template.ts`** - Generates src/server.ts (if applicable)
4. **`{type}/templates/client.template.ts`** - Generates src/client.ts (if applicable)
5. **`{type}/templates/edge.template.ts`** - Generates src/edge.ts (if applicable)

Platform-specific exports are determined by `platform-utils.ts:resolvePlatformExports()`.

---

## See Also

- [ARCHITECTURE_OVERVIEW.md](./ARCHITECTURE_OVERVIEW.md) - Overall architecture patterns
- [NX_STANDARDS.md](./NX_STANDARDS.md) - Nx workspace standards
- [EFFECT_PATTERNS.md](./EFFECT_PATTERNS.md) - Effect-TS patterns
